version: v1beta1
kind: Spicepod
name: spice-oss-docs

datasets:
  - from: github:github.com/spiceai/docs/files/trunk
    name: spiceai.docs
    description: Spice.ai OSS documentation and reference, from https://docs.spiceai.org
    metadata:
      reference_base_url: https://docs.spiceai.org/<docs_path>, exclude `spiceaidocs` prefix from docs path
    params:
      github_token: ${secrets:GITHUB_TOKEN}
      include: "spiceaidocs/docs/**/*.md"
    acceleration:
      enabled: true
      refresh_check_interval: 12h
      refresh_jitter_enabled: true
      refresh_jitter_max: 5m
    embeddings:
      - column: content
        use: openai_embeddings
        column_pk:
          - path
  
  - from: github:github.com/spiceai/samples/files/trunk
    name: spiceai.samples
    description: Spice.ai OSS samples
    metadata:
      reference_base_url: https://github.com/spiceai/samples/tree/trunk/<sample_path>
    params:
      github_token: ${secrets:GITHUB_TOKEN}
      include: "**/*.md"
    acceleration:
      enabled: true
      refresh_check_interval: 12h
      refresh_jitter_enabled: true
      refresh_jitter_max: 5m
    embeddings:
      - column: content
        use: openai_embeddings
        column_pk:
          - path

  - from: github:github.com/spiceai/quickstarts/files/trunk
    name: spiceai.quickstarts
    description: Spice.ai OSS quickstarts
    metadata:
      reference_base_url: https://github.com/spiceai/quickstarts/tree/trunk/<quickstart_path>
    params:
      github_token: ${secrets:GITHUB_TOKEN}
      include: "**/*.md"
    acceleration:
      enabled: true
      refresh_check_interval: 12h
      refresh_jitter_enabled: true
      refresh_jitter_max: 5m
    embeddings:
      - column: content
        use: openai_embeddings
        column_pk:
          - path

embeddings:
  - from: openai
    name: openai_embeddings
    params:
      openai_api_key: ${secrets:OPENAI_API_KEY}

  - name: hf_minilm
    from: huggingface:huggingface.co/sentence-transformers/all-MiniLM-L6-v2

models:
  - name: openai
    from: openai:gpt-4o
    params:
      spice_tools: auto
      openai_api_key: ${secrets:OPENAI_API_KEY}
      system_prompt: |
        You are an AI assistant assisting engineers with the Spice.ai OSS Project.

        Always strive to be accurate, concise, and helpful in your responses.

        Prefer spiceai.docs for documentation and reference information questions.
        
        Prefer spiceai.samples and spiceai.quickstarts for use cases, sample code, and configuration questions. Always include links to relevant samples or quickstarts.

        Use the SQL tool when:
          1. The query involves precise numerical data, statistics, or aggregations.
          2. The user asks for specific counts, sums, averages, or other calculations.
          3. The query requires joining or comparing data from multiple related tables.

        If the SQL tool returns a query, syntax, or planning error, call the `list_datasets` tool to get the available tables and continue to refine and retry the query until it succeeds. If it continues to fail after 10 attempts, fall back to other available tools.

        When returning results from datasets, always provide citations and reference links if possible.

        Use the document search tool when:
          1. The query is about unstructured text information, such as policies, reports, or articles.
          2. The user is looking for qualitative information or explanations.
          3. The query requires understanding context or interpreting written content.

        General guidelines:
          1. If a query could be answered by either tool, prefer SQL for more precise, quantitative answers.

